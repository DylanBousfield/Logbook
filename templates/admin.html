<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 40px;
    background-color: #f4f7fb;
    color: #333;
}

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}
header h1 { margin: 0; color: #2c3e50; }

.card {
    background: #fff;
    padding: 25px;
    margin-bottom: 30px;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    width: 100%;
}

.grid { display: flex; gap: 20px; flex-wrap: wrap; }
.grid .card { flex: 1 1 300px; }

.logs-card h2 { margin: 0; color: #2c3e50; }

.export-btn {
    background: #3498db;
    padding: 10px 18px;
    border-radius: 5px;
    color: white;
    border: none;
    cursor: pointer;
    transition: 0.3s;
}
.export-btn:hover { opacity: 0.9; }

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
table th, table td {
    border: 1px solid #e0e0e0;
    padding: 10px;
    vertical-align: middle;
}
table th { background: #3498db; color: white; }
table tr:nth-child(even) { background: #f8f9fa; }

/* Employee/Workplace table styling */
.card:not(.logs-card) table td {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}
.card:not(.logs-card) table td form { margin: 0; }

/* Buttons */
.card button.delete {
    background: #dc3545;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
}
.card button.delete:hover { opacity: 0.9; }

/* Employee/Workplace input form */
.card form input[name="name"] {
    flex: 2;
    min-width: 0;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
}
.card form button {
    flex: 1;
    max-width: 120px;
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    background: #3498db;
    color: white;
    cursor: pointer;
    transition: 0.3s;
}
.card form button:hover { opacity: 0.9; }

a { display: inline-block; margin-top: 15px; color: #3498db; text-decoration: none; }
a:hover { text-decoration: underline; }

@media (max-width: 600px) {
    .logs-card table { display: block; overflow-x: auto; width: 100%; }
    .logs-card table td, .logs-card table th { white-space: nowrap; }
    .card:not(.logs-card) table td { flex-direction: column; align-items: flex-start; }
}
</style>
</head>
<body>

<header>
    <h1>Admin Panel</h1>
</header>

<!-- Work Logs Card -->
<div class="card logs-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2>Work Logs</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
            <select id="employeeFilter">
                <option value="">All Employees</option>
                {% for emp in employees %}
                <option value="{{ emp.id }}">{{ emp.name }}</option>
                {% endfor %}
            </select>
            <select id="workplaceFilter">
                <option value="">All Workplaces</option>
                {% for wp in workplaces %}
                <option value="{{ wp.id }}">{{ wp.name }}</option>
                {% endfor %}
            </select>
            <button class="export-btn" id="exportBtn">⬇ Export to Excel</button>
        </div>
    </div>

    <table id="logsTable">
        <thead>
            <tr>
                <th>Employee</th>
                <th>Workplace</th>
                <th>Date</th>
                <th>Hours</th>
                <th>Description</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Employee & Workplace Cards -->
<div class="grid">
    <!-- Employee Card -->
    <div class="card">
        <h2>Employees</h2>
        <form method="POST" action="/add_employee">
            <input type="text" name="name" placeholder="Employee Name" required>
            <button type="submit">Add</button>
        </form>
        <table>
            <tbody>
                {% for e in employees %}
                <tr>
                    <td>
                        {{ e.name }}
                        <form method="POST" action="/delete_employee/{{ e.id }}">
                            <button class="delete" type="submit" onclick="return confirm('Are you sure?')">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Workplace Card -->
    <div class="card">
        <h2>Workplaces</h2>
        <form method="POST" action="/add_workplace">
            <input type="text" name="name" placeholder="Workplace Name" required>
            <button type="submit">Add</button>
        </form>
        <table>
            <tbody>
                {% for w in workplaces %}
                <tr>
                    <td>
                        {{ w.name }}
                        <form method="POST" action="/delete_workplace/{{ w.id }}">
                            <button class="delete" type="submit" onclick="return confirm('Are you sure?')">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<a href="/">⬅ Back to Work Log</a>

<script>
// Filters and logs table
const employeeFilter = document.getElementById('employeeFilter');
const workplaceFilter = document.getElementById('workplaceFilter');
const logsTableBody = document.querySelector('#logsTable tbody');
const exportBtn = document.getElementById('exportBtn');

// Fetch logs from backend
function fetchLogs() {
    const params = new URLSearchParams();
    if (employeeFilter.value) params.append('employee_id', employeeFilter.value);
    if (workplaceFilter.value) params.append('workplace_id', workplaceFilter.value);

    fetch(`/filter_logs?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
            logsTableBody.innerHTML = '';
            data.logs.forEach(log => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${log.employee}</td>
                    <td>${log.workplace}</td>
                    <td>${log.date}</td>
                    <td>${log.hours}</td>
                    <td>${log.description}</td>
                    <td>
                        <button class="delete" onclick="deleteLog(${log.id})">Delete</button>
                    </td>
                `;
                logsTableBody.appendChild(tr);
            });

            // Update export button
            exportBtn.onclick = () => {
                window.location = `/export?${params.toString()}`;
                return false;
            };
        });
}

// Delete log via fetch
function deleteLog(id) {
    if (!confirm('Are you sure you want to delete this log?')) return;
    fetch(`/delete_log/${id}`, { method: 'POST' })
        .then(() => fetchLogs()); // refresh table after deletion
}

// Initial load
fetchLogs();
employeeFilter.addEventListener('change', fetchLogs);
workplaceFilter.addEventListener('change', fetchLogs);
</script>
</body>
</html>
