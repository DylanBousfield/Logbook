<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7fb; padding: 20px; }
        .card { background: white; padding: 20px; margin-bottom: 30px; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        table, th, td { border: 1px solid #ddd; }
        th, td { padding: 10px; text-align: left; }
        button { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; }
        .delete { background: #dc3545; color: white; }
        .delete:hover { opacity: 0.9; }
        form { display: inline; margin: 0; }
        select, .export-btn { padding: 6px 10px; margin-right: 10px; }
        .filters { margin-bottom: 10px; }
    </style>
</head>
<body>
<h1>Admin Panel</h1>

<div class="card">
    <h2>Work Logs</h2>

    <div class="filters">
        <select id="employeeFilter">
            <option value="">All Employees</option>
            {% for emp in employees %}
            <option value="{{ emp.id }}">{{ emp.name }}</option>
            {% endfor %}
        </select>

        <select id="workplaceFilter">
            <option value="">All Workplaces</option>
            {% for wp in workplaces %}
            <option value="{{ wp.id }}">{{ wp.name }}</option>
            {% endfor %}
        </select>

        <button class="export-btn" id="exportBtn">⬇ Export to Excel</button>
    </div>

    <table id="logsTable">
        <thead>
            <tr>
                <th>Employee</th>
                <th>Workplace</th>
                <th>Date</th>
                <th>Hours</th>
                <th>Description</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.employee.name }}</td>
                <td>{{ log.workplace.name }}</td>
                <td>{{ log.date }}</td>
                <td>{{ log.hours }}</td>
                <td>{{ log.description }}</td>
                <td>
                    <form method="POST" action="/delete_log/{{ log.id }}">
                        <button class="delete" type="submit" onclick="return confirm('Are you sure?')">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h2>Employees</h2>
    <form method="POST" action="/add_employee">
        <input type="text" name="name" placeholder="Employee Name" required>
        <button type="submit">Add</button>
    </form>
    <table>
        <tbody>
            {% for e in employees %}
            <tr>
                <td>{{ e.name }}
                    <form method="POST" action="/delete_employee/{{ e.id }}">
                        <button class="delete" type="submit" onclick="return confirm('Are you sure?')">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h2>Workplaces</h2>
    <form method="POST" action="/add_workplace">
        <input type="text" name="name" placeholder="Workplace Name" required>
        <button type="submit">Add</button>
    </form>
    <table>
        <tbody>
            {% for w in workplaces %}
            <tr>
                <td>{{ w.name }}
                    <form method="POST" action="/delete_workplace/{{ w.id }}">
                        <button class="delete" type="submit" onclick="return confirm('Are you sure?')">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<a href="/">⬅ Back to Work Log</a>

<script>
const employeeFilter = document.getElementById('employeeFilter');
const workplaceFilter = document.getElementById('workplaceFilter');
const logsTableBody = document.querySelector('#logsTable tbody');
const exportBtn = document.getElementById('exportBtn');

function fetchLogs() {
    const employeeId = employeeFilter.value;
    const workplaceId = workplaceFilter.value;

    const params = new URLSearchParams();
    if (employeeId) params.append('employee_id', employeeId);
    if (workplaceId) params.append('workplace_id', workplaceId);

    fetch(`/filter_logs?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
            logsTableBody.innerHTML = '';
            data.logs.forEach(log => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${log.employee}</td>
                    <td>${log.workplace}</td>
                    <td>${log.date}</td>
                    <td>${log.hours}</td>
                    <td>${log.description}</td>
                    <td>
                        <form method="POST" action="/delete_log/${log.id}">
                            <button class="delete" type="submit" onclick="return confirm('Are you sure?')">Delete</button>
                        </form>
                    </td>
                `;
                logsTableBody.appendChild(tr);
            });

            exportBtn.onclick = () => {
                window.location = `/export?${params.toString()}`;
                return false;
            };
        });
}

// Initial load
fetchLogs();

// Update logs when filters change
employeeFilter.addEventListener('change', fetchLogs);
workplaceFilter.addEventListener('change', fetchLogs);
</script>
</body>
</html>
