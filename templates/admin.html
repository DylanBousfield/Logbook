<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:40px;background:#f4f7fb;color:#333;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;}
header h1{margin:0;color:#2c3e50;}
.card{background:#fff;padding:25px;margin-bottom:30px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.1);}
.grid{display:flex;gap:20px;flex-wrap:wrap;}
.grid .card{flex:1 1 300px;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
table th,table td{border:1px solid #e0e0e0;padding:10px;text-align:left;}
table th{background:#3498db;color:#fff;}
table tr:nth-child(even){background:#f8f9fa;}
button.delete{background:#dc3545;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;}
button.delete:hover{opacity:0.9;}
button.add{background:#3498db;color:white;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;}
button.add:hover{opacity:0.9;}
.export-btn{background:#3498db;color:white;border:none;padding:10px 18px;border-radius:5px;cursor:pointer;}
.export-btn:hover{opacity:0.9;}
a{display:inline-block;margin-top:15px;color:#3498db;text-decoration:none;}
a:hover{text-decoration:underline;}
</style>
</head>
<body>

<header>
<h1>Admin Panel</h1>
<img src="{{ url_for('static',filename='storm_logo.png') }}" alt="Logo" height="60">
</header>

<div class="card logs-card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
<h2>Work Logs</h2>
<div style="display:flex;gap:10px;align-items:center;">
<select id="employeeFilter">
<option value="">All Employees</option>
{% for emp in employees %}<option value="{{ emp.id }}">{{ emp.name }}</option>{% endfor %}
</select>
<select id="workplaceFilter">
<option value="">All Workplaces</option>
{% for wp in workplaces %}<option value="{{ wp.id }}">{{ wp.name }}</option>{% endfor %}
</select>
<button class="export-btn" id="exportBtn">⬇ Export to Excel</button>
</div>
</div>

<table id="logsTable">
<thead><tr>
<th>Employee</th><th>Workplace</th><th>Date</th><th>Hours</th><th>Description</th><th>Delete</th>
</tr></thead>
<tbody>{% for log in logs %}
<tr data-id="{{ log.id }}">
<td>{{ log.employee.name }}</td>
<td>{{ log.workplace.name }}</td>
<td>{{ log.date }}</td>
<td>{{ log.hours }}</td>
<td>{{ log.description }}</td>
<td>
<form method="POST" action="/delete_log/{{ log.id }}"><button class="delete" type="submit">Delete</button></form>
</td>
</tr>{% endfor %}</tbody>
</table>
</div>

<div class="grid">
<!-- Employee -->
<div class="card">
<h2>Employees</h2>
<form id="addEmployeeForm">
<input type="text" id="employeeName" placeholder="Employee Name" required>
<button type="submit" class="add">Add</button>
</form>
<table id="employeeTable">
<tbody>{% for e in employees %}
<tr data-id="{{ e.id }}">
<td>{{ e.name }}
<form method="POST" action="/delete_employee/{{ e.id }}">
<button class="delete" type="submit">Delete</button>
</form>
</td>
</tr>{% endfor %}</tbody>
</table>
</div>

<!-- Workplace -->
<div class="card">
<h2>Workplaces</h2>
<form id="addWorkplaceForm">
<input type="text" id="workplaceName" placeholder="Workplace Name" required>
<button type="submit" class="add">Add</button>
</form>
<table id="workplaceTable">
<tbody>{% for w in workplaces %}
<tr data-id="{{ w.id }}">
<td>{{ w.name }}
<form method="POST" action="/delete_workplace/{{ w.id }}">
<button class="delete" type="submit">Delete</button>
</form>
</td>
</tr>{% endfor %}</tbody>
</table>
</div>
</div>

<a href="/">⬅ Back to Work Log</a>

<script>
async function postForm(url,data={}) {
    const response = await fetch(url,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams(data)});
    return response.json();
}

// ---------- Add Employee ----------
document.getElementById('addEmployeeForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const input=document.getElementById('employeeName');
    const data=await postForm('/add_employee',{name:input.value.trim()});
    if(data.success){
        const tbody=document.querySelector('#employeeTable tbody');
        const tr=document.createElement('tr'); tr.dataset.id=data.id;
        tr.innerHTML=`<td>${data.name}<form method="POST" action="/delete_employee/${data.id}"><button class="delete" type="submit">Delete</button></form></td>`;
        tbody.appendChild(tr);
        const filter=document.getElementById('employeeFilter');
        const option=document.createElement('option'); option.value=data.id; option.text=data.name; filter.add(option);
        input.value='';
    }else alert(data.error);
});

// ---------- Add Workplace ----------
document.getElementById('addWorkplaceForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const input=document.getElementById('workplaceName');
    const data=await postForm('/add_workplace',{name:input.value.trim()});
    if(data.success){
        const tbody=document.querySelector('#workplaceTable tbody');
        const tr=document.createElement('tr'); tr.dataset.id=data.id;
        tr.innerHTML=`<td>${data.name}<form method="POST" action="/delete_workplace/${data.id}"><button class="delete" type="submit">Delete</button></form></td>`;
        tbody.appendChild(tr);
        const filter=document.getElementById('workplaceFilter');
        const option=document.createElement('option'); option.value=data.id; option.text=data.name; filter.add(option);
        input.value='';
    }else alert(data.error);
});

// ---------- Delete ----------
document.addEventListener('click', async e=>{
    if(!e.target.matches('button.delete')) return;
    if(!confirm('Are you sure?')) return;
    const form=e.target.closest('form'); const action=form.action;
    const data=await postForm(action);
    if(data.success){ const tr=form.closest('tr'); if(tr) tr.remove(); } else alert(data.error);
});

// ---------- Filter Logs ----------
async function fetchLogs(){
    const empId=document.getElementById('employeeFilter').value;
    const wpId=document.getElementById('workplaceFilter').value;
    const params=new URLSearchParams();
    if(empId) params.append('employee_id',empId);
    if(wpId) params.append('workplace_id',wpId);
    const res=await fetch(`/filter_logs?${params.toString()}`);
    const data=await res.json();
    const tbody=document.querySelector('#logsTable tbody');
    tbody.innerHTML='';
    data.logs.forEach(log=>{
        const tr=document.createElement('tr'); tr.dataset.id=log.id;
        tr.innerHTML=`<td>${log.employee}</td><td>${log.workplace}</td><td>${log.date}</td><td>${log.hours}</td><td>${log.description}</td>
        <td><form method="POST" action="/delete_log/${log.id}"><button class="delete" type="submit">Delete</button></form></td>`;
        tbody.appendChild(tr);
    });
    const exportBtn=document.getElementById('exportBtn');
    exportBtn.onclick=()=>{ window.location=`/export?${params.toString()}`; return false; };
}

fetchLogs();
document.getElementById('employeeFilter').addEventListener('change',fetchLogs);
document.getElementById('workplaceFilter').addEventListener('change',fetchLogs);
</script>

</body>
</html>
